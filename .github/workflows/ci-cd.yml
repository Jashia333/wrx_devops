name: CI/CD

on:
  push:
    branches: [main]

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'docker-compose.yml'
              - '.github/workflows/ci-cd.yml'
            frontend:
              - 'frontend/**'
              - 'docker-compose.yml'
              - '.github/workflows/ci-cd.yml'

  backend:
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image
        run: docker build -t wrx-backend:latest ./backend

      # Push to registry (uncomment and add secrets to enable):
      # Docker Hub: add DOCKERHUB_USERNAME, DOCKERHUB_TOKEN
      #   - run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
      #   - run: docker tag wrx-backend:latest <your-registry>/wrx-backend:latest && docker push <your-registry>/wrx-backend:latest
      # GitHub Container Registry: use GITHUB_TOKEN
      #   - run: docker tag wrx-backend:latest ghcr.io/${{ github.repository_owner }}/wrx-backend:latest
      #   - run: docker push ghcr.io/${{ github.repository_owner }}/wrx-backend:latest

  frontend:
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build frontend image
        run: docker build -t wrx-frontend:latest ./frontend

      # Push to registry (uncomment and add secrets to enable):
      # Docker Hub: add DOCKERHUB_USERNAME, DOCKERHUB_TOKEN
      #   - run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
      #   - run: docker tag wrx-frontend:latest <your-registry>/wrx-frontend:latest && docker push <your-registry>/wrx-frontend:latest
      # GitHub Container Registry: use GITHUB_TOKEN
      #   - run: docker tag wrx-frontend:latest ghcr.io/${{ github.repository_owner }}/wrx-frontend:latest
      #   - run: docker push ghcr.io/${{ github.repository_owner }}/wrx-frontend:latest
